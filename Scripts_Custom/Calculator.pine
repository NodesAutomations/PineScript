//@version=5
indicator("Calculator",overlay= true)
import vkpunique/PineHelper/11 as ph

//General variables
[dayOpen,dayHigh,dayLow,dayClose] = request.security(syminfo.tickerid, "1D", [open,high,low,close])
[preDayOpen,preDayHigh,preDayLow,preDayClose] = request.security(syminfo.tickerid, "1D", [open[1],high[1],low[1],close[1]])
var data= array.new<ph.Result>()

//Relative Volume
today_vol = request.security(syminfo.tickerid, "D", volume)
yday_vol = request.security(syminfo.tickerid, "D", volume[1])
avg_vol = request.security(syminfo.tickerid, "D", ta.sma(yday_vol, 20))
float rvol_Percentate =ph.IsStock()?(today_vol / avg_vol):0

////Candle Stats
open_Percentage=ph.Percentage(dayOpen,preDayClose)  
gap_Percentage= ph.Percentage(dayLow,preDayClose)  
candleHigh_Percentage= ph.Percentage(close,dayHigh)
candleLow_Percentage= ph.Percentage(close,dayLow)
dcr_Percentage=(dayClose-dayLow)/(dayHigh-dayLow)

//Stoploss
GetSL(x)=>math.round_to_mintick(math.round(x*(1-0.002),2))
float stoploss = GetSL(dayLow)
float preDayStoploss = GetSL(preDayLow)
stoploss_Percentage=ph.Percentage(close,stoploss)
preDay_stoploss_Percentage= ph.Percentage(close,preDayStoploss)

//Quantity
int positionSize=input.int(400, "Position", minval=200, maxval=1000, step=1)*1000
int qty=math.round(positionSize/close)

//1m calculations
newbar(res) => ta.change(time(res)) == 0 ? 0 : 1
// Returns 1st min close at open RTH at 09:30 close of the current symbol.
OPENtimeOk =  timestamp(syminfo.timezone, year(time), month(time), dayofmonth(time), 9, 15) == time
Timeok = OPENtimeOk or timeframe.period == "D"

//1 min High Calculations
firststminHigh = request.security_lower_tf(syminfo.tickerid, "1", high)
Highvalue_0 = newbar (timeframe.period) and array.size(firststminHigh) > 0 ? array.first(firststminHigh): na
Highvalue = OPENtimeOk? Highvalue_0 :na
var float fmh = na
fmh := Timeok ?Highvalue: fmh[1]
oneMinuteHigh=timeframe.isintraday?fmh[1]:Highvalue_0

//1 min Low Calculations
firststminLow = request.security_lower_tf(syminfo.tickerid, "1", low)
Lowvalue_0 = newbar (timeframe.period) and array.size(firststminLow) > 0 ? array.first(firststminLow): na
Lowvalue = OPENtimeOk? Lowvalue_0 :na
var float fml = na
fml := Timeok ?Lowvalue: fml[1]
oneMinuteLow=timeframe.isintraday?fml[1]:Lowvalue_0
if barstate.islast 
    ph.AddResult(data,"RVol",ph.ToPercentage(rvol_Percentate),rvol_Percentate>0?ph.GetBGColorUp(rvol_Percentate,0.15,0.3,0.5):na)
    ph.AddResult(data)
    ph.AddResult(data,"DCR",ph.ToPercentage(dcr_Percentage), ph.GetBGColorUp(dcr_Percentage,0.15,0.3,0.5))
    ph.AddResult(data,"Open",ph.ToPercentage(open_Percentage),ph.GetBGColorUp(open_Percentage,-0.01,0,0.01))
    ph.AddResult(data,"Gap",ph.ToPercentage(gap_Percentage),ph.GetBGColorUp(gap_Percentage,-0.01,0,0.01))
    ph.AddResult(data,"High",ph.ToPercentage(candleHigh_Percentage),na)
    ph.AddResult(data,"Low",ph.ToPercentage(candleLow_Percentage),na)
    ph.AddResult(data)
    ph.AddResult(data,"SL AT","DayLow",na)
    ph.AddResult(data,"SL%",ph.ToPercentage(stoploss_Percentage),ph.GetBGColorDown(stoploss_Percentage,0.04,0.03,0.02))
    ph.AddResult(data,"SL",ph.ToOneDecimal(stoploss),color(na))
    ph.AddResult(data)
    ph.AddResult(data,"SL AT","PreLow",na)
    ph.AddResult(data,"SL%",ph.ToPercentage(preDay_stoploss_Percentage),ph.GetBGColorDown(preDay_stoploss_Percentage,0.04,0.03,0.02))
    ph.AddResult(data,"SL",ph.ToOneDecimal(preDayStoploss),color(na))
    ph.AddResult(data)
    ph.AddResult(data,"Pos",ph.ToThousand(positionSize),na)
    ph.AddResult(data,"QTY",ph.ToNoDecimal(qty),na)
    ph.GenerateTable(data,"top_right",ph.TableOrientation.Verticle)

    var data2= array.new<ph.Result>()
    
    ph.AddResult(data2,"1mHigh",str.tostring(oneMinuteHigh),color(na))
    ph.AddResult(data2,"1mHigh%",ph.ToPercentage(ph.Percentage(close,oneMinuteHigh)),color(na))
    ph.AddResult(data2,"1mLow",str.tostring(oneMinuteLow),color(na))
    ph.AddResult(data2,"1mLow%",ph.ToPercentage(ph.Percentage(close,oneMinuteLow)),color(na))
    ph.GenerateTable(data2,"bottom_right",ph.TableOrientation.Verticle)